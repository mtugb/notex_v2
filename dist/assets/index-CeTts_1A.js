(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const _=[{name:["alpha","a"],type:"text",compose:()=>"Î±"},{name:["beta","b"],type:"text",compose:()=>"Î²"},{name:["gamma","g"],type:"text",compose:()=>"Î³"},{name:["delta","d"],type:"text",compose:()=>"Î´"},{name:["epsilon","e"],type:"text",compose:()=>"Îµ"},{name:["pi"],type:"text",compose:()=>"Ï€"},{name:["sigma","s"],type:"text",compose:()=>"Ïƒ"},{name:["omega","w"],type:"text",compose:()=>"Ï‰"},{name:["union","cup","u"],type:"text",compose:()=>"âˆª"},{name:["intersection","cap"],type:"text",compose:()=>"âˆ©"},{name:["in","element","belong"],type:"text",compose:()=>"âˆˆ"},{name:["notin","notin"],type:"text",compose:()=>"âˆ‰"},{name:["subset","sub"],type:"text",compose:()=>"âŠ‚"},{name:["subseteq","subseteq"],type:"text",compose:()=>"âŠ†"},{name:["empty","emptyset"],type:"text",compose:()=>"âˆ…"},{name:["difference","setdiff"],type:"text",compose:()=>"âˆ–"},{name:["not","lnot"],type:"text",compose:()=>"ï¿¢"},{name:["and","land","wedge","katu"],type:"text",compose:()=>"âˆ§"},{name:["or","lor","vee","mataha"],type:"text",compose:()=>"âˆ¨"},{name:["implies","then","arrow","naraba"],type:"text",compose:()=>"â‡’"},{name:["iff","equiv","equivalent","douti"],type:"text",compose:()=>"â‡”"},{name:["forall","any"],type:"text",compose:()=>"âˆ€"},{name:["exists","exist"],type:"text",compose:()=>"âˆƒ"},{name:["neq","notequal"],type:"text",compose:()=>"â‰ "},{name:["leq","le","lesseq"],type:"text",compose:()=>"â‰¤"},{name:["geq","ge","greatereq"],type:"text",compose:()=>"â‰¥"},{name:["approx","similar"],type:"text",compose:()=>"â‰ˆ"},{name:["infinity","inf"],type:"text",compose:()=>"âˆž"},{name:["nabla","del"],type:"text",compose:()=>"âˆ‡"},{name:["partial","p"],type:"text",compose:()=>"âˆ‚"},{name:["theta"],type:"text",compose:()=>"Î¸"},{name:["Theta"],type:"text",compose:()=>"Î˜"},{name:["Delta"],type:"text",compose:()=>"Î”"},{name:["Pi"],type:"text",compose:()=>"Î "}],E=[{name:["pmat","pmatrix"],type:"html",compose(t){let e=Number(t?.[3]),n=Number(t?.[2]);(!e||!n)&&(e=2,n=2),console.log({columns:e,rows:n});let o=[],s=[];for(let i=0;i<e;i++)s.push({tag:"td",text:"â–¡",focus:!0});for(let i=0;i<n;i++)o.push({tag:"tr",children:s});return{tag:"div",class:"pt-bracket pt-bracket--round",children:[{tag:"table",class:"pt-matrix",children:o}]}}},{name:["bmat","bmatrix"],type:"html",compose(t){let e=Number(t?.[3]),n=Number(t?.[2]);(!e||!n)&&(e=2,n=2),console.log({columns:e,rows:n});let o=[],s=[];for(let i=0;i<e;i++)s.push({tag:"td",text:"â–¡",focus:!0});for(let i=0;i<n;i++)o.push({tag:"tr",children:s});return{tag:"div",class:"pt-bracket pt-bracket--array",children:[{tag:"table",class:"pt-matrix",children:o}]}}},{name:["integral","int"],type:"html",compose(t){return{class:"pt-integral",children:[{class:"pt-integral__lower-limit",children:[{text:t?.[2]??"â–¡",focus:{withArg:!1,noArg:!0}}]},{class:"pt-integral__upper-limit",children:[{text:t?.[3]??"â–¡",focus:{withArg:!1,noArg:!0}}]},{class:"pt-integral__symbol"}]}}},{name:["sigma","sum"],type:"html",compose(t){return{class:"pt-sigma",children:[{class:"pt-sigma__lower-limit",text:"i = 1",focus:!0},{class:"pt-sigma__upper-limit",text:"n",focus:!0},{class:"pt-sigma__symbol"}]}}},{name:["^"],type:"html",compose(t){return console.log(t),{class:"pt-sup",text:t?.[2]??"â–¡"}}},{name:["_"],type:"html",compose(t){return console.log(t),{class:"pt-sub",text:t?.[2]??"â–¡"}}},{name:["hat"],type:"html",compose(t){return{class:"pt-accent pt-accent--hat",text:t?.[2]??"â–¡",focus:!0}}},{name:["cdots"],type:"html",compose(){return{class:"pt-dots pt-dots--cdots",editable:!1}}},{name:["vdots"],type:"html",compose(){return{class:"pt-dots pt-dots--vdots",editable:!1}}},{name:["ddots"],type:"html",compose(){return{class:"pt-dots pt-dots--ddots",editable:!1}}},..._];function O(){return E.flatMap(t=>t.name)}function x(){return document.getSelection()?.getRangeAt(0)??null}function w(){const e=x()?.startContainer;return e instanceof Node?e:null}function $(t,e=0,n=0){const o=document.getSelection(),s=document.createRange();o?.removeAllRanges(),s.setStart(t,e),s.setEnd(t,n),o?.addRange(s)}const B=O();class q{constructor(e,n){this.editor=e,this.area=n,n.style.display="none"}complements=null;get isOpen(){return!!this.complements}setupList(e){const n=B.filter(o=>o.startsWith(e));this.complements=n.length>0?new I(n,e):null}changeSelection(e){this.complements?.changeSelection(e)}render(){this.area.style.display=this.isOpen?"block":"none";const e=this.complements;if(!e)return;const n=x();if(!n)return;const{left:o,top:s}=n.getBoundingClientRect(),{left:i,top:a}=this.editor.getBoundingClientRect();this.area.style.left=`calc(${o-i}px + 1.5em)`,this.area.style.top=`calc(${s-a}px + 1.5em)`,this.area.innerHTML=e.list.map((c,u)=>`<li ${u===e.selection?'class="selected"':""}><span>${c.slice(0,e.source.length)}</span>${c.slice(e.source.length)}</li>`).join("")}close(){this.complements=null}apply(){if(!this.complements)return;const e=x();if(!e)return;const n=this.complements.list[this.complements.selection].slice(this.complements.source.length),o=e.startContainer;o instanceof Text&&(o.textContent+=n,e.setStart(o,o.textContent.length),e.collapse())}}class I{constructor(e,n){this.list=e,this.source=n}selection=0;changeSelection(e){switch(e){case"up":{this.selection=Math.max(0,this.selection-1);break}case"down":{this.selection=Math.min(this.list.length-1,this.selection+1);break}}}}class P{dirHandle=null;dirViewArea;constructor(){this.dirViewArea=document.getElementById("dirView")}setDirHandle(e){this.dirHandle=e,this.updateDirView(),this.saveFile(".ntconfig.json","{}")}async updateDirView(){if(!this.dirHandle||!this.dirViewArea)return;this.dirViewArea.innerHTML="";const e=await D(this.dirHandle),n=H(e);this.dirViewArea.replaceChildren(...n)}async saveFile(e,n){if(!this.dirHandle)return;const s=await(await this.dirHandle.getFileHandle(e,{create:!0})).createWritable();await s.write(n),await s.close()}async saveFileAs(e){const n=await window.showSaveFilePicker({suggestedName:"newNote.ntx",types:[{description:"Notex file",accept:{"application/x-notex":[".ntx"]}}]}),o=await n.createWritable();return await o.write(e),await o.close(),n.name}}async function D(t){const e=[];for await(const[n,o]of t.entries()){const s={name:n,kind:o.kind,handle:o};o.kind==="directory"&&(s.children=await D(o)),e.push(s)}return e}function H(t){const e=[];for(const n of t){let o;if(n.kind==="directory"){o=document.createElement("details");const s=document.createElement("summary");s.textContent=`ðŸ“ ${n.name}`,o.appendChild(s);const i=document.createElement("div");i.classList.add("subitem");for(const a of H(n.children))i.appendChild(a);o.appendChild(i)}else{if(!n.name.endsWith(".ntx"))continue;o=document.createElement("div"),o.textContent=`ðŸ“„ ${n.name}`,o.onclick=async()=>{const a=await(await n.handle.getFile()).text();console.log("ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:",a),le(a)}}e.push(o)}return e}const V="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let W=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+=V[n[t]&63];return e};function A(t){const e=document.createElement(t.tag??"div"),n={withArg:[],noArg:[]};return t.class&&e.classList.add(...t.class.split(" ")),e.contentEditable=t.editable===!1?"false":"true",e.textContent=t.text??"",typeof t.focus=="boolean"?(n.withArg.push(e),n.noArg.push(e)):(t.focus?.withArg&&n.withArg.push(e),t.focus?.noArg&&n.noArg.push(e)),t.children?.forEach(o=>{const s=A(o);e.appendChild(s.html),n.withArg.push(...s.elementsToFocus?.withArg??[]),n.noArg.push(...s.elementsToFocus?.noArg??[])}),{html:e,elementsToFocus:n}}class Z{constructor(e){this.tabArea=e}openedFiles=[];focusedFileId=null;get isAllFileSaved(){return this.openedFiles.every(e=>!e.isChanged)}openFile(e){this.openedFiles.push({id:W(8),fileSystemFileHandle:e,name:e.name,isChanged:!1})}closeFile(e){this.openedFiles=this.openedFiles.filter(n=>n.id!==e)}switchTab(e){this.focusedFileId=e}renderTabs(){this.tabArea.replaceChildren(...this.openedFiles.map(e=>A({class:"tab ntx",children:[{tag:"span",text:e.name},{class:"close",children:[{tag:"i",class:"fa-solid fa-xmark"+e.id===this.focusedFileId?" focused":""}]}]}).html))}}const v="â€‹";class z{constructor(e){this.list=e}selection=0}class K{focusList=null;constructor(){}prev(){this.focusList&&(this.focusList.selection=Math.max(0,this.focusList.selection-1),C(this.focusList.list[this.focusList.selection]))}next(){this.focusList&&(this.focusList.list.some(e=>e instanceof HTMLElement&&e.closest("table"))||j(),this.focusList.selection=Math.min(this.focusList.list.length-1,this.focusList.selection+1),C(this.focusList.list[this.focusList.selection]))}focus(e){this.focusList=new z(e),console.log({focusList:this.focusList}),C(e[0])}blur(){this.focusList&&(this.focusList=null)}get isActive(){return!!this.focusList}}function C(t){console.log("---fire!!!!");const e=document.getSelection();if(!e){console.error("no selection");return}const n=document.createRange();t.childNodes[0]instanceof Text&&(t=t.childNodes[0]),console.log({node:t}),n.setStart(t,0),n.setEnd(t,t.textContent?.length??0),e.removeAllRanges(),e.addRange(n)}function j(){const t=w();t&&t.textContent==="â–¡"&&(t.textContent=v)}function U(t,e){e.isOpen&&(t.preventDefault(),e.changeSelection("down"),e.render())}function G(t,e){e.isOpen&&(t.preventDefault(),e.changeSelection("up"),e.render())}function J(t,e){t.preventDefault(),e.isOpen?(e.apply(),e.close(),e.render()):Q()}function Q(){const t=w();if(!t){console.error("no startcontainer");return}let e;if(t instanceof HTMLElement&&(e=t.closest(".row")),t instanceof Text&&(e=t?.parentElement?.closest(".row")),e){const n=document.createElement("div");n.classList.add("row"),n.appendChild(document.createElement("br")),e.insertAdjacentElement("afterend",n),$(n)}else console.error("no parent row")}function X(t){t.preventDefault(),document.execCommand("insertText",!1," + ")}function Y(t){t.preventDefault(),document.execCommand("insertText",!1," âˆ’ ")}function ee(t){t.preventDefault(),document.execCommand("insertText",!1," = ")}function te(t){t.preventDefault(),document.execCommand("insertText",!1," Ã— ")}function ne(t,e,n){const o=t[1],s=E.find(i=>i.name.includes(o));if(s)switch(s.type){case"html":{R("noArg",t,s.compose(),e);break}case"text":{se(t,s.compose());break}}}function L(t,e,n){const o=t[1],s=E.find(i=>i.name.includes(o));if(s)switch(s.type){case"html":{R("withArg",t,s.compose(t),e);break}}}function se(t,e){const n=document.getSelection(),o=n?.getRangeAt(0),s=o?.startContainer;if(!n||!o||!s)return;const i=o.startOffset-t[0].length,a=o.startOffset,c=document.createRange();c.setStart(s,i),c.setEnd(s,a),c.deleteContents();const u=document.createTextNode(e);c.insertNode(u),c.collapse(),n.removeAllRanges(),n.addRange(c)}function R(t,e,n,o){const s=A(n),i=document.getSelection(),a=i?.getRangeAt(0),c=a?.startContainer;if(!i||!a||!c)return;const u=a.startOffset-e[0].length,h=a.startOffset,r=document.createRange();r.setStart(c,u),r.setEnd(c,h),r.deleteContents();const g=document.createTextNode(v);r.insertNode(g),r.insertNode(s.html),r.insertNode(document.createTextNode(v));const l=s.elementsToFocus?.[t];let b=!1;o&&l&&l?.length>0?(o.focus([...l,g]),b=!0):r.setStartAfter(g),b||(i.removeAllRanges(),i.addRange(r))}function oe(t,e,n,o){if(!document.getSelection())return;const i=x(),a=w();if(!i||!a){console.log("no range or node");return}if(!(a instanceof Text)){console.log("nottext");return}const c=a.textContent.slice(0,i.startOffset),u=c.match(/\\([a-zA-Z]+)$/);if(u){o?.keyEvent?.preventDefault(),ne(u,e);return}const h=c.match(/\\([a-zA-Z]+)\{([0-9]{0,2})\}\{([0-9]{0,2})\}$/);if(h){o?.keyEvent?.preventDefault(),L(h,e);return}const r=c.match(/([\^\_])([a-zA-Z0-9]+)$/);if(r){o?.keyEvent?.preventDefault(),L(r,e);return}const g=c.match(/([\^\_])(\(.+\))$/);if(g){o?.keyEvent?.preventDefault(),L(g,e);return}let l=c.match(/([a-zA-Z0-9âˆ‚]+)\/([a-zA-Z0-9âˆ‚]+)$/);if(l||(l=c.match(/\((.+)\)\/\((.+)\)$/)),l){console.info("matched"),o?.keyEvent?.preventDefault();const b={class:"pt-fraction",children:[{class:"pt-fraction__upper",children:[{text:l[1]??"a"}]},{class:"pt-fraction__lower",children:[{text:l[2]??"b"}]}]},M=A(b),p=x(),k=w();if(!p||!k)return;p.setStart(k,p.startOffset-l[0].length),p.deleteContents();const F=document.createTextNode(v);p.insertNode(F),p.insertNode(M.html),p.setStart(F,0),p.collapse();return}}function ie(t,e,n){oe(e,n,"spaceKey",{keyEvent:t})}const ae=(t,e,n)=>{n.isActive&&(t.preventDefault(),t.shiftKey?n.prev():n.next())},S={Enter:J,ArrowUp:G,ArrowDown:U," ":ie,"+":X,"-":Y,"=":ee,"*":te,Tab:ae},d=document.getElementById("editor");let m=null;const ce=document.getElementById("complement"),y=new q(d,ce),re=new K,N=document.querySelector(".file-tabs");let T=null,f=null;if(N instanceof HTMLDivElement){T=new Z(N),f=T?new P:null,d.addEventListener("keydown",s=>{d.innerHTML.trim()==='<div class="row"><br></div>'&&s.key==="Backspace"&&s.preventDefault(),s.key in S&&S[s.key](s,y,re),(async()=>{if(s.ctrlKey&&s.key==="s"){s.preventDefault();try{m?f?.saveFile(m,d.innerHTML):(m=await f?.saveFileAs(d.innerHTML)??"",o.textContent=m)}catch(i){console.error({"ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š":i})}}})()}),d.addEventListener("keyup",s=>{(()=>{if(!/^[a-z]$|^Backspace$|^ArrowRight$|^ArrowLeft$/.test(s.key)||!document.getSelection())return;const a=x(),c=w();if(!a||!c){console.log("no range or node");return}if(!(c instanceof Text)){console.log("nottext");return}const h=c.textContent.slice(0,a.startOffset).match(/\\(\S+)$/);if(!h){y.close();return}setTimeout(()=>{y.setupList(h[1]),y.render()},100)})(),s.key===" "&&(y.close(),y.render()),s.key==="Insert"&&console.log({fileTabController:T})});const t=document.getElementById("openDir");t&&"showDirectoryPicker"in window&&(t.onclick=async()=>{const s=await window.showDirectoryPicker({mode:"readwrite"});for await(const[i,a]of s.entries())console.log({name:i});f?.setDirHandle(s),f?.updateDirView(),t.style.display="none"});const e=document.getElementById("saveFileBtn"),n=document.getElementById("saveFileAsBtn"),o=document.getElementById("fileName");n.onclick=async()=>{m=await f?.saveFileAs(d.innerHTML)??"",o.textContent=m},e.onclick=async()=>{m?f?.saveFile(m,d.innerHTML):(m=await f?.saveFileAs(d.innerHTML)??"",o.textContent=m)},document.addEventListener("keydown",s=>{if(s.ctrlKey&&s.key==="d"){s.preventDefault();const i=getSelection();console.log({selection:i})}})}else console.error("[ERROR] .file-tabs not founded");function le(t){d.innerHTML=t}
